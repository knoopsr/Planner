@page "/planner"
@using BlazorApp1.Shared
@using Models.SchedulerPro



<DxPopup @bind-Visible="IsProjectPopupVisible"
         ShowCloseButton="true"
         CloseOnOutsideClick="true"
         Width="800px"
         Height="600px"
         HeaderText="Project details">

    <BodyTemplate>
        @if (SelectedProjectId.HasValue)
        {
            <ProjectDetail ProjectId="SelectedProjectId.Value"
                           OnClose="CloseProjectPopup" />
        }
    </BodyTemplate>
</DxPopup>




<div class="planner-full">
        <SchedulerPro @ref="Scheduler"
                      Resources="Resources"
                      Events="Events"
                      OnEventClick="HandleEventClick"
                      OnEventDblClick="HandleEventDblClick"
                      OnEventAdded="HandleEventAdded"
                      OnEventUpdated="HandleEventUpdated"
                      OnEventRemoved="HandleEventRemoved"
                  OnEventDragStart="HandleEventDragStart"
                  OnEventDrag="HandleEventDrag"
                  OnEventDrop="HandleEventDrop" 
                  OnUnplannedDrop="HandleUnplannedDrop" />
    </div>

   @*  <div class="col-3">
        <h5>Geselecteerd project</h5>
        @if (SelectedEvent is null)
        {
            <p class="text-muted">Klik op een taak in de planner.</p>
        }
        else
        {
            <div class="card">
                <div class="card-body">
                    <div><strong>ProjectId:</strong> @SelectedEvent.ProjectId</div>
                    <div><strong>Naam:</strong> @SelectedEvent.Name</div>
                    <div><strong>Resource:</strong> @SelectedEvent.ResourceId</div>
                    <div><strong>Periode:</strong> @SelectedEvent.StartDate:dd/MM/yyyy - @SelectedEvent.EndDate:dd/MM/yyyy</div>
                </div>
            </div>
        }

        <hr />

        <button class="btn btn-sm btn-primary mb-1" @onclick="NieuwEventToevoegen">
            Nieuw event toevoegen (C# -> JS)
        </button>



        <button class="btn btn-primary" @onclick="() => OpenProjectPopup(101)">
            Test: open project 101
        </button>
    </div> *@




@code {
    private SchedulerPro? Scheduler;

    private List<ResourceDto> Resources = new();
    private List<SchedulerEventDto> Events = new();

    private SchedulerEventDto? SelectedEvent;

    protected override void OnInitialized()
    {
        // hier later: echte data uit API
        Resources = new()
        {
            new ResourceDto { Id = 1, Name = "Ploeg 1" },
            new ResourceDto { Id = 2, Name = "Ploeg 2" }
        };

        Events = new()
        {
            new SchedulerEventDto
            {
                Id = 1,
                Name = "Project A - Opmeting",
                ResourceId = 1,
                StartDate = new DateTime(2025, 1, 2),
                EndDate   = new DateTime(2025, 1, 3),
                ProjectId = 101
            },
            new SchedulerEventDto
            {
                Id = 2,
                Name = "Project B - Plaatsing",
                ResourceId = 2,
                StartDate = new DateTime(2025, 1, 5),
                EndDate   = new DateTime(2025, 1, 7),
                ProjectId = 202
            },
            new SchedulerEventDto
            {
                Id = 3,
                Name = "Project C - Afwerking", 
                StartDate = null,
                EndDate = null,
                ProjectId = 303
            }

        };
    }

    private Task HandleEventClick(SchedulerEventDto e)
    {
        SelectedEvent = e;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private Task HandleEventDblClick(SchedulerEventDto e)
    {
        // hier kan je bv. naar /project/{id} navigeren
        Console.WriteLine($"Dubbelklik op event {e.Id} (Project {e.ProjectId})");
        return Task.CompletedTask;
    }

    private Task HandleEventAdded(List<SchedulerEventDto> nieuweEvents)
    {
        // gebruiker heeft een event toegevoegd in Bryntum (bijv. via editor)
        // hier sla je ze op in je DB
        Console.WriteLine($"Toegevoegd in scheduler: {nieuweEvents.Count} events");
        return Task.CompletedTask;
    }

    private Task HandleEventUpdated(SchedulerEventDto e)
    {
        // gebruiker heeft event gewijzigd in Bryntum (drag/drop, resize, editor)
        // hier update je je DB
        Console.WriteLine($"Event {e.Id} aangepast, nieuwe periode: {e.StartDate} - {e.EndDate}");
        return Task.CompletedTask;
    }

    private Task HandleEventRemoved(List<int> ids)
    {
        // gebruiker heeft event(s) verwijderd in Bryntum
        Console.WriteLine($"Verwijderd ids: {string.Join(",", ids)}");
        return Task.CompletedTask;
    }

    private async Task NieuwEventToevoegen()
    {
        if (Scheduler is null) return;

        var nieuw = new SchedulerEventDto
        {
            Id = 999, // in echte app: id van DB
            Name = "Nieuw project (C#)",
            ResourceId = 1,
            StartDate = new DateTime(2025, 1, 10),
            EndDate   = new DateTime(2025, 1, 12),
            ProjectId = 999
        };

        // direct in de planner zetten, zonder alles te refreshen
        await Scheduler.AddEventAsync(nieuw);
    }


    private bool IsProjectPopupVisible;
    private int? SelectedProjectId;

    private void OpenProjectPopup(int projectId)
    {
        SelectedProjectId = projectId;
        IsProjectPopupVisible = true;
    }

    private void CloseProjectPopup()
    {
        IsProjectPopupVisible = false;
    }
    private Task HandleEventDragStart(EventDragPayloadDto payload)
    {
        Console.WriteLine($"Drag start: {payload.Events.Count} event(s), resource {payload.Ctx.ResourceId}");
        return Task.CompletedTask;
    }
    private Task HandleEventDrag(EventDragPayloadDto payload)
    {
        return Task.CompletedTask;
    }
    private Task HandleEventDrop(EventDragPayloadDto payload)
    {
        foreach (var ev in payload.Events)
        {
            Console.WriteLine($"Drop event {ev.Id} -> resource {payload.Ctx.ResourceId}, {payload.Ctx.StartDate} - {payload.Ctx.EndDate}");
        }
        return Task.CompletedTask;
    }


    private Task HandleUnplannedDrop(UnplannedDropPayloadDto payload)
    {
        foreach (var ev in payload.Events)
        {
            Console.WriteLine($"Unplanned drop: event {ev.Id} -> resource {payload.ResourceId}");
            // hier later: DB updaten
        }
        return Task.CompletedTask;
    }
}
